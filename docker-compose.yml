services:
  # MySQL 数据库服务
  mysql:
    image: mysql:8.0
    container_name: poetize-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USERNAME}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      TZ: Asia/Shanghai
    volumes:
      - mysql-data:/var/lib/mysql
      - ./poetize-server/sql/poetize.sql:/docker-entrypoint-initdb.d/poetry.sql:ro
    # 安全：不暴露端口到宿主机，仅内部网络访问
    ports:
       - "23306:3306"
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-authentication-plugin=mysql_native_password
      # 增强安全配置
      - --skip-name-resolve
      - --max-connections=100
      - --innodb-buffer-pool-size=128M  # 限制 MySQL 内存使用
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis 缓存服务
  redis:
    image: redis:7-alpine
    container_name: poetize-redis
    restart: always
    # 安全：不暴露端口到宿主机
    # ports:
    #   - "6379:6379"
    volumes:
      - redis-data:/data
    # 启用密码认证和 AOF 持久化
    command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # 博客应用服务
  poetize-app:
    image: ${ACR_REGISTRY}/${ACR_NAMESPACE}/poetize:latest
    container_name: poetize-app
    restart: always
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/${MYSQL_DATABASE}?allowPublicKeyRetrieval=true&useSSL=false&useUnicode=true&characterEncoding=utf-8&serverTimezone=Asia/Shanghai
      SPRING_DATASOURCE_USERNAME: ${MYSQL_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_PASSWORD}
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PORT: 6379
      SPRING_REDIS_PASSWORD: ${REDIS_PASSWORD}
      MAIL_USERNAME: ${MAIL_USERNAME}
      MAIL_PASSWORD: ${MAIL_PASSWORD}
      MAIL_ENABLE: ${MAIL_ENABLE}
      LOCAL_DOWNLOAD_URL: https://${DOMAIN}/resourceStorage/
      CORS_ALLOWED_ORIGINS: https://${DOMAIN},https://www.${DOMAIN}
      TZ: Asia/Shanghai
      # JVM 参数 - 优化内存使用
      JAVA_OPTS: -Xms256m -Xmx512m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+UseStringDeduplication
    volumes:
      - app-storage:/app/resourceStorage
      - app-logs:/app/logs
    # 安全：不暴露应用端口，通过 Nginx 访问
    # ports:
    #   - "8081:8081"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    # 限制资源使用
    deploy:
      resources:
        limits:
          memory: 600M
          cpus: '0.8'
        reservations:
          memory: 256M
          cpus: '0.3'

  # Nginx 反向代理服务
  nginx:
    image: nginx:alpine
    container_name: poetize-nginx
    restart: always
    depends_on:
      - poetize-app
    ports:
      - "8080:80"            # ← 内部端口，非公开访问
      - "8443:443"           # ← 内部端口，非公开访问
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - app-storage:/app/resourceStorage:ro         # 用于直接提供静态资源
      - nginx-logs:/var/log/nginx
      # SSL 证书挂载（配置域名后添加）
      # - ./nginx/ssl:/etc/nginx/ssl:ro
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3
    # 限制 Nginx 资源使用
    deploy:
      resources:
        limits:
          memory: 100M
          cpus: '0.5'
        reservations:
          memory: 32M
          cpus: '0.1'

volumes:
  mysql-data:
    driver: local
  redis-data:
    driver: local
  app-storage:
    driver: local
  app-logs:
    driver: local
  nginx-logs:
    driver: local

networks:
  default:
    name: poetize-network
    driver: bridge